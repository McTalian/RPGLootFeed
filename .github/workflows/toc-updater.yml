name: Update TOC Interface version(s)

on:
  workflow_dispatch:
  schedule:
    - cron: 0 12 * * *

permissions:
  contents: write
  pull-requests: write

env:
  ADDON: RPGLootFeed

jobs:
  run:
    runs-on: ubuntu-latest
    steps:
      - name: Clone project
        uses: actions/checkout@v4

      - name: Update TOC Interface version
        uses: Mctalian/wow-build-tools/toc/update@v1-beta
        with:
          args: -a ${{ env.ADDON }} -b -p

      - name: Detect change type
        id: change-type
        run: |
          # Extract old and new interface versions from git diff
          OLD_VERSIONS=$(git diff ${{ env.ADDON }}/${{ env.ADDON }}.toc | grep '^-## Interface:' | sed 's/^-## Interface: //' || echo "")
          NEW_VERSIONS=$(git diff ${{ env.ADDON }}/${{ env.ADDON }}.toc | grep '^+## Interface:' | sed 's/^+## Interface: //' || echo "")

          # Count versions in old and new
          OLD_COUNT=$(echo "$OLD_VERSIONS" | grep -o ',' | wc -l || echo 0)
          NEW_COUNT=$(echo "$NEW_VERSIONS" | grep -o ',' | wc -l || echo 0)

          # Add 1 to counts since comma count = version count - 1
          OLD_COUNT=$((OLD_COUNT + 1))
          NEW_COUNT=$((NEW_COUNT + 1))

          if [ "$NEW_COUNT" -gt "$OLD_COUNT" ]; then
            echo "pr_title=toc: bump versions, please submit any bugs" >> $GITHUB_OUTPUT
            echo "commit_message=toc: bump versions, please submit any bugs" >> $GITHUB_OUTPUT
            echo "Detected version additions (toc commit): $OLD_COUNT -> $NEW_COUNT versions"
          else
            echo "pr_title=chore: remove old interface versions" >> $GITHUB_OUTPUT
            echo "commit_message=chore: remove old interface versions" >> $GITHUB_OUTPUT
            echo "Detected only version removals or no change (chore commit): $OLD_COUNT -> $NEW_COUNT versions"
          fi

      - name: Set up uv
        uses: astral-sh/setup-uv@v6
        with:
          enable-cache: true

      - name: Sync uv environment
        run: uv sync

      - name: Install playwright
        run: uv run playwright install

      - name: Check for hidden currencies
        run: make generate_hidden_currencies

      - name: Create pull request
        uses: peter-evans/create-pull-request@v8
        with:
          token: ${{ secrets.GH_PAT }}
          title: ${{ steps.change-type.outputs.pr_title }}
          body: |
            ## Requirements

            - [ ] Download test package in the comments below
            - [ ] Test for all applicable game clients
              - [ ] Retail (PTR? Beta?)
              - [ ] Classic (PTR? Beta?)
              - [ ] Classic Anniversary (PTR? Beta?)
              - [ ] Classic Era (PTR? Beta?)
            - [ ] Review any new Hidden Currencies

            ----------------------------------------------------
            _This PR was automatically created to update the supported interface versions in ${{ env.ADDON }}.toc._
          commit-message: ${{ steps.change-type.outputs.commit_message }}
          branch: interface-version
          delete-branch: true
